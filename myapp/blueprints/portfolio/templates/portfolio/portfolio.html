{% extends "home.html" %}

{% block custom_css %}
    <link rel="stylesheet" href="{{url_for('portfolio.static', filename='css/portfolio_menu.css')}}">
{% endblock custom_css %}

{% block content %}
    <main class="content flex-grow-1 p-4">
        <div class="container">
            <h1>Select a Portfolio</h1>
            
            <div class="search-filter">
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Search portfolios...">
                </div>
                <select id="filter-select">
                    <option value="all">All Types</option>
                    {% for type in portfolio_types.values() %}
                    <option value="{{ type }}">{{ type }}</option>
                    {% endfor %}
                </select>
                <button class="suggested-portfolios">‚ú® Suggested Portfolios</button>
            </div>

            <div id="portfolio-grid" class="portfolio-grid">
                {# Portfolio cards to be generated by calling filterPortfolios() when webpage first loads  #}
            </div>
        </div>
        
        <div id="portfolioModal" class="modal">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle" class="modal-title"></h2>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <img id="modalImage" src="" alt="" class="modal-image">
                        <p id="modalAllocation" class="modal-allocation"></p>
                        <p id="modalDescription" class="modal-description"></p>
                    </div>
                    <div class="modal-footer">
                        <form action="{{ url_for('portfolio.invest') }}" method="post">
                            <input type="hidden" name="portfolio" value="">
                            <button class="invest-button" type="submit">Invest Now</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock content %}

{% block custom_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function(){

            const portfolios = {{ portfolios|tojson|safe}};
            const portfolio_types = {{portfolio_types|tojson|safe}}
        
            const searchInput = document.getElementById('search-input');
            const filterSelect = document.getElementById('filter-select');
            const portfolioGrid = document.getElementById('portfolio-grid');


            function filterPortfolios() {
                const searchTerm = searchInput.value.toLowerCase();
                const filterType = filterSelect.value;

                portfolioGrid.innerHTML = '';

                portfolios.forEach(portfolio => {
                    if ((filterType === 'all' ||
                        portfolio.type.some(type => type === filterType)) &&
                        portfolio.name.toLowerCase().includes(searchTerm)) {

                        const card = createPortfolioCard(portfolio, portfolio_types);
                        portfolioGrid.appendChild(card);

                        // Generate id of 'View details' button
                        const button_id = '#'+portfolio.name.replace(/\s+/g, '-');

                        // Add portfolio data to the button so that we can pass the data to our modal later
                        $(button_id).data('portfolio', portfolio);
                    }
                });
            }

            function createPortfolioCard(portfolio, portfolio_types) {
                const card = document.createElement('div');

                // Create id for 'View details' button so that we can refer to it later
                const id = portfolio.name.replace(/\s+/g, '-');

                card.className = 'portfolio-card';

                card.innerHTML = `
                    <div class="portfolio-card-header">
                        <h2 class="portfolio-name">${portfolio.name}</h2>
                    </div>
                    <div class="portfolio-card-content">
                        <p class="portfolio-type">${ portfolio.type.join(", ") }</p>
                        <p class="portfolio-description">${ portfolio.short_description }</p>
                        <img src="static/images/${portfolio.image_url}" alt="${portfolio.name}" class="portfolio-card-image">
                    </div>
                    <div class="portfolio-card-footer">
                        <button class="open-modal" id=${id} data-bs-toggle="modal" data-bs-target="#portfolioModal">View Details</button>
                    </div>
                `;

                return card;
            }
            
            // Update modal content dynamically
             $(document).ready(function () {
                $('.open-modal').on('click', function () {

                    const portfolio = $(this).data('portfolio');

                    $('#modalImage').attr("src", "static/images/"+portfolio.image_url);
                    $('#modalTitle').text(portfolio.name);
                    $('#modalDescription').text(portfolio.long_description);
                    $('form input[name="portfolio"]').attr("value", JSON.stringify(portfolio));

                    // Formats allocations into string with the following format:
                    // Asset 1: 40%
                    // Asset 2 : 60%
                    const allocation_str = Object.entries(portfolio.allocation).map(([asset, percentage]) => `${asset}: ${percentage} %`).join('<br>');
                    $('#modalAllocation').html(allocation_str);

                });
             });
           
            searchInput.addEventListener('input', filterPortfolios);
            filterSelect.addEventListener('change', filterPortfolios);

            // Initial filter
            filterPortfolios();

        })
    </script>
{% endblock custom_js %}

