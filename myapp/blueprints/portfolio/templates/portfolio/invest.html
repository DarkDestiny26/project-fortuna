{% extends "home.html" %}

{% block custom_css %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{url_for('portfolio.static', filename='css/invest.css')}}" rel="stylesheet" >
{% endblock custom_css %}

{% block content %}
    <main class="content flex-grow-1 p-4">
        <div class="container">
            <h1>{{portfolio.name}}</h1>

            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card stats-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                            <div class="stats-label">Daily Performance</div>
                            <div class="stats-value text-success" id="dailyChange"></div>
                            <div class="badge badge-success">
                                <i class="fas fa-chart-line me-1"></i>Today
                            </div>
                        </div>
                        <div class="icon primary">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="stats-label">Risk Level</div>
                                <div class="stats-value">
                                    {% set filtered_labels = portfolio.labels | selectattr("type", "equalto", "risk") | list %}
                                    {% for label in filtered_labels %}
                                        {{ label.text.split()[0] }}
                                    {% endfor %}
                                </div>
                                <div class="risk-meter">
                                    <div class="risk-level risk-medium" style="width: 65%;"></div>
                                </div>
                                <div class="badge badge-success">
                                    <i class="fas fa-shield-alt me-1"></i>Balanced
                                </div>
                            </div>
                            <div class="icon primary">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Summary -->
            <div class="row g-4 mb-4">
                <!-- Portfolio Returns Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title">Portfolio Returns</h5>
                            <div class="btn-group" role="group" aria-label="Time period">
                                <button type="button" class="btn btn-outline-primary period-btn active" data-period="6m">6M</button>
                                <button type="button" class="btn btn-outline-primary period-btn" data-period="1y">1Y</button>
                                <button type="button" class="btn btn-outline-primary period-btn" data-period="5y">5Y</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <canvas id="returnsChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Asset Allocation Chart -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title">Asset Allocation</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4">
                 <!-- Assets Table -->
                <div class="col-md-9">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Portfolio Assets</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="assetsTable">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th class="text-end">Price</th>
                                            <th class="text-end">Change (%)</th>
                                            <th class="text-end">Allocation</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Table rows will be populated by jQuery -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchase Interface -->
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title">Purchase Portfolio Units</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label for="unitsInput" class="form-label stats-label">Number of Units</label>
                                <input type="number" class="form-control" id="unitsInput" min="1" value="1">
                            </div>
                            <div class="mb-4">
                                <div class="stats-label">Total Cost</div>
                                <div class="stats-value" id="totalCost">$125,000</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary w-100" id="purchaseBtn">Purchase Portfolio</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock content %}

{% block custom_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script>

        // Initialize everything when document is ready
        $(document).ready(function() {

            // Sample portfolio data
            const portfolio = {
                totalValue: 125000,
                dailyChange: 2.3,
                assets: [
                    { id: 1, name: 'AAPL', price: 180.5, change: 0, allocation: 7.22 },
                    { id: 2, name: 'GOOGL', price: 2850.2, change: 0, allocation: 34.20 },
                    { id: 3, name: 'MSFT', price: 378.9, change: 0, allocation: 30.31 },
                    { id: 4, name: 'AMZN', price: 145.2, change: 0, allocation: 23.23 },
                    { id: 5, name: 'TSLA', price: 210.8, change: 0, allocation: 5.04 }
                ]
            };

    
            // Format currency
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(value);
            };

            function fetchStockPrices() {
                const tickers = portfolio.assets.map(asset => asset.name); // Get tickers from portfolio object

                $.ajax({
                    url: "get_stock_prices",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ tickers: tickers }),
                    success: function(data) {
                        portfolio.assets.forEach(asset => {
                            if (data[asset.name]) {
                                asset.price = data[asset.name].price; // Update asset price
                                asset.change = data[asset.name].change; // Percentage change
                            }
                        });
                        populateTable();
                    },
                    error: function(error) {
                        console.error("Error fetching stock prices:", error);
                    }
                });
            }

            let selectedPeriod = "6m"; // Default period

            function fetchPortfolioReturns() {
                return new Promise((resolve, reject) => {
                    const tickers = portfolio.assets.map(asset => asset.name);
                    const allocations = {};
                    portfolio.assets.forEach(asset => {
                        allocations[asset.name] = asset.allocation / 100; // Convert allocation to decimal
                    });

                    $.ajax({
                        url: "get_portfolio_returns",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({ tickers: tickers, allocations: allocations, period: selectedPeriod }),
                        success: function(data) {
                            if (data.dates && data.returns) {
                                renderReturnsChart(data.dates, data.returns); // Call chart update
                                resolve(); // Ensure the next function runs after this is done
                            } else {
                                console.error("Error fetching portfolio returns:", data);
                                reject(data);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error fetching portfolio returns:", status, error);
                        }
                    });
                })
            }

            function fetchDailyPerformance() {
                const tickers = portfolio.assets.map(asset => asset.name);
                const allocations = {};
                portfolio.assets.forEach(asset => {
                    allocations[asset.name] = asset.allocation / 100; // Convert allocation to decimal
                });

                $.ajax({
                    url: "get_daily_performance",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ tickers: tickers, allocations: allocations }),
                    success: function(data) {
                        if (data.daily_return !== undefined) {

                            const dailyReturn = (data.daily_return * 100).toFixed(2); // Convert to percentage
                            
                            // Update card text
                            $("#dailyChange").text(`${dailyReturn}%`);

                            // Change color based on positive/negative return
                            if (dailyReturn > 0) {
                                $("#dailyChange").removeClass("text-danger").addClass("text-success");
                                $("#dailyChange").prepend("+");
                            } else {
                                $("#dailyChange").removeClass("text-success").addClass("text-danger");
                            }
                        } else {
                            console.error("Error fetching daily performance:", data);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error fetching daily performance:", status, error);
                    }
                });
            }

            // Populate assets table
            function populateTable() {
                const tbody = $('#assetsTable tbody');
                tbody.empty();
                
                portfolio.assets.forEach(asset => {
                    const changeClass = asset.change >= 0 ? "text-success" : "text-danger"; // Green for positive, red for negative   

                    tbody.append(`
                        <tr class="asset-row" data-asset-id="${asset.id}">
                            <td>${asset.name}</td>
                            <td class="text-end ${changeClass}">${formatCurrency(asset.price)}</td>
                            <td class="text-end ${changeClass}">${asset.change.toFixed(2)}%</td>
                            <td class="text-end">${asset.allocation.toFixed(2)}%</td>
                        </tr>
                    `);
                });
            }

            // Initialize pie chart
            function initializePieChart() {
                const ctx = document.getElementById('pieChart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: portfolio.assets.map(asset => asset.name),
                        datasets: [{
                            data: portfolio.assets.map(asset => asset.allocation),
                            backgroundColor: [
                                '#6366f1',
                                '#22c55e',
                                '#eab308',
                                '#ef4444',
                                '#8b5cf6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        family: "'Inter', sans-serif",
                                        size: 12
                                    },
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            }

            let returnsChart;

            /*
            function initializeReturnsChart(period = '6m') {
                const ctx = document.getElementById('returnsChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (returnsChart) {
                    returnsChart.destroy();
                }

                // Calculate cumulative returns
                const data = returnsData[period];
                let cumulativeReturns = [];
                let sum = 0;
                data.returns.forEach(ret => {
                    sum += ret;
                    cumulativeReturns.push(sum);
                });

                returnsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Cumulative Return %',
                            data: cumulativeReturns,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Return: ${context.raw.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            } */

            function renderReturnsChart(dates, returns) {
                const ctx = document.getElementById('returnsChart').getContext('2d');

                if (returnsChart) {
                    returnsChart.data.labels = dates;
                    returnsChart.data.datasets[0].data = returns.map(r => r * 100); // Convert to %
                    returnsChart.update();
                } else {
                    returnsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Portfolio Cumulative Return (%)',
                                data: returns.map(r => r * 100),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 1,
                                pointBackgroundColor: '#10b981'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Return: ${context.raw.toFixed(2)}%`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                                y: { 
                                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(1) + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            // Handle time period button clicks
            $('.period-btn').on('click', function() {
                $('.period-btn').removeClass('active'); // Remove active class from all buttons
                $(this).addClass('active'); // Highlight selected button
                selectedPeriod = $(this).data('period'); // Update selected period
                fetchPortfolioReturns(); // Fetch new data for the selected period
            });

            // Handle purchase units input
            $('#unitsInput').on('input', function() {
                const units = Math.max(1, parseInt($(this).val()) || 1);
                const totalCost = portfolio.totalValue * units;
                $('#totalCost').text(formatCurrency(totalCost));
            });

            // Handle purchase button click
            $('#purchaseBtn').on('click', function() {
                const units = parseInt($('#unitsInput').val());
                const totalCost = portfolio.totalValue * units;
                alert(`Purchase confirmed!\nUnits: ${units}\nTotal Cost: ${formatCurrency(totalCost)}`);
            });

            // Initialise table and charts
            populateTable();
            initializePieChart();

            // Initial fetch
            fetchStockPrices();

            // Fetch portfolio returns first (historical data for the chart)
            fetchPortfolioReturns().then(() => {
                // Once returns data is loaded, fetch daily performance
                fetchDailyPerformance();
            });

            // Refresh stock prices in table every minute
            setInterval(fetchStockPrices, 60000);

            // Refresh daily return every hour
            setInterval(fetchDailyPerformance, 3600000);
        
        });

    </script>
{% endblock custom_js %}